{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Checkout - MancingMo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
<style>
/* Voucher Styles */
.voucher-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.section-subtitle {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #333;
}

.voucher-input-group {
    display: flex;
    gap: 10px;
}

#voucherCode {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

#voucherCode:focus {
    outline: none;
    border-color: #4285f4;
}

.btn-apply-voucher {
    padding: 12px 20px;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
}

.btn-apply-voucher:hover {
    background: #3367d6;
}

.btn-apply-voucher:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.voucher-message {
    margin-top: 8px;
    font-size: 14px;
    min-height: 20px;
    padding: 8px 12px;
    border-radius: 4px;
    font-weight: 500;
}

.voucher-message.success {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.voucher-message.error {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.voucher-message:empty {
    display: none;
}

.applied-voucher {
    margin-top: 10px;
}

.voucher-success {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 6px;
    color: #155724;
}

.voucher-success > div {
    flex: 1;
    margin-left: 10px;
}

.voucher-success strong {
    display: block;
    margin-bottom: 2px;
}

.remove-voucher-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.remove-voucher-btn:hover {
    background: rgba(220, 53, 69, 0.1);
}

/* Update summary untuk menampilkan discount */
.discount-row {
    color: #28a745;
}

.discount-row .amount {
    color: #28a745;
    font-weight: 600;
}

/* Style untuk shipping cost preview */
.shipping-cost-preview {
    margin: 15px 0;
}

.shipping-cost-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    color: #155724;
}

.shipping-cost-card svg {
    flex-shrink: 0;
}

.shipping-cost-card div {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

/* Style untuk form help text */
.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #6b7280;
}

/* Style untuk select district */
#district {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background-color: white;
}

#district:focus {
    outline: none;
    border-color: #4285f4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

/* Style untuk shipping type */
.shipping-type-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.shipping-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.shipping-option {
    flex: 1;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.shipping-option:hover {
    border-color: #4285f4;
}

.shipping-option.selected {
    border-color: #4285f4;
    background: #f0f7ff;
}

.shipping-option input {
    display: none;
}

.shipping-option-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.shipping-option-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.shipping-option-details {
    flex: 1;
}

.shipping-option-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
}

.shipping-option-desc {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.shipping-option-price {
    font-weight: 600;
    color: #4285f4;
}

/* Style untuk button states */
.btn-continue {
    width: 100%;
    padding: 15px;
    background-color: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.btn-continue:hover:not(:disabled) {
    background-color: #3367d6;
    transform: translateY(-2px);
}

.btn-continue:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* Style untuk error state */
.input-error {
    border-color: #e74c3c !important;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="checkout-hero">
    <div class="container">
        <a href="{% if is_buy_now %}javascript:history.back(){% else %}{% url 'cart' %}{% endif %}" class="back-button">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="page-title">Check Out</h1>
        <div class="breadcrumb">
            <a href="{% url 'home' %}">Home</a>
            <span class="separator">â€º</span>
            {% if not is_buy_now %}
            <a href="{% url 'cart' %}">Cart</a>
            <span class="separator">â€º</span>
            {% endif %}
            <span class="current">Check Out</span>
        </div>
    </div>
</section>

<!-- Checkout Content -->
<section class="checkout-content">
    <div class="container">
        <div class="checkout-grid">
            <!-- Left Column - Shipping & Payment Info -->
            <div class="checkout-left">
                <form method="POST" id="checkoutForm">
                    {% csrf_token %}
                    
                    <!-- Hidden inputs untuk selected items (hanya untuk mode cart) -->
                    {% if not is_buy_now %}
                        {% for item in cart_items %}
                        <input type="hidden" name="selected_items" value="{{ item.id }}">
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Hidden input untuk payment method (hanya midtrans) -->
                    <input type="hidden" name="payment_method" value="midtrans">
                    <input type="hidden" name="shipping_type" id="shippingType" value="reguler">
                    
                    <!-- Info Pengiriman -->
                    <div class="checkout-section">
                        <h2 class="section-title">Info Pengiriman</h2>
                        
                        <div class="login-status">
                            <div>
                                <p class="status-text">Masuk sebagai</p>
                                <p class="status-value">{{ user.first_name }} {{ user.last_name }}</p>
                            </div>
                            {% if user_profile.address or default_address %}
                            <button type="button" class="use-saved-address-btn" onclick="useSavedAddress()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Gunakan Alamat Default
                            </button>
                            {% endif %}
                        </div>

                        {% if not user_profile.address and not default_address %}
                        <div class="address-notice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <p>Anda belum menyimpan alamat. Lengkapi form di bawah atau <a href="{% url 'edit_profile' %}">perbarui profil</a> Anda.</p>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="full_name">Nama Lengkap *</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Masukkan nama lengkap" 
                                   value="{% if user_profile.address %}{{ user.first_name }} {{ user.last_name }}{% elif default_address %}{{ default_address.full_name }}{% else %}{{ user.first_name }} {{ user.last_name }}{% endif %}" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Nomor Telepon *</label>
                            <input type="tel" id="phone" name="phone" placeholder="Contoh: 08123456789" 
                                   value="{% if user_profile.phone %}{{ user_profile.phone }}{% elif default_address %}{{ default_address.phone }}{% endif %}" required>
                        </div>

                        <div class="form-group">
                            <label for="address">Alamat Lengkap *</label>
                            <textarea id="address" name="address" rows="3" placeholder="Jl. Contoh No. 123, RT/RW, Kelurahan, Kecamatan" required>{% if user_profile.address %}{{ user_profile.address }}{% elif default_address %}{{ default_address.address }}{% endif %}</textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">Kota *</label>
                                <input type="text" id="city" name="city" placeholder="Contoh: Makassar" 
                                       value="{% if user_profile.city %}{{ user_profile.city }}{% elif default_address %}{{ default_address.city }}{% endif %}" required readonly style="background-color: #f5f5f5;">
                                <small class="form-help">Saat ini hanya melayani pengiriman di Makassar</small>
                            </div>
                            <div class="form-group">
                                <label for="province">Provinsi *</label>
                                <input type="text" id="province" name="province" placeholder="Contoh: Sulawesi Selatan" 
                                       value="{% if user_profile.province %}{{ user_profile.province }}{% elif default_address %}{{ default_address.province }}{% endif %}" required readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>

                        <!-- âœ… FIELD BARU: DROPDOWN KECAMATAN -->
                        <div class="form-group">
                            <label for="district">Kecamatan *</label>
                            <select id="district" name="district" required onchange="updateShippingCost()">
                                <option value="">Pilih Kecamatan</option>
                                {% for kecamatan in kecamatan_list %}
                                <option value="{{ kecamatan.kecamatan }}" 
                                        {% if user_profile.district == kecamatan.kecamatan %}selected{% endif %}>
                                    {{ kecamatan.kecamatan }} - Rp {{ kecamatan.harga|format_currency }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-help">Pilih kecamatan untuk melihat biaya pengiriman</small>
                        </div>

                        <div class="form-group">
                            <label for="postal_code">Kode Pos (Opsional)</label>
                            <input type="text" id="postal_code" name="postal_code" placeholder="90123" 
                                   value="{% if user_profile.postal_code %}{{ user_profile.postal_code }}{% elif default_address %}{{ default_address.postal_code }}{% endif %}">
                        </div>

                        <!-- âœ… TAMPILAN BIAYA PENGIRIMAN REAL-TIME -->
                        <div class="shipping-cost-preview" id="shippingCostPreview" style="display: none;">
                            <div class="shipping-cost-card">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                                <div>
                                    <strong>Biaya Pengiriman Reguler:</strong>
                                    <span id="shippingCostDisplay">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… SECTION JENIS PENGIRIMAN -->
                        <div class="shipping-type-section" id="shippingTypeSection" style="display: none;">
                            <h3 class="section-subtitle">Jenis Pengiriman</h3>
                            
                            <div class="shipping-options">
                                <div class="shipping-option selected" onclick="selectShippingType('reguler')">
                                    <input type="radio" name="shipping_type_radio" value="reguler" checked>
                                    <div class="shipping-option-content">
                                        <div class="shipping-option-icon">
                                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                            </svg>
                                        </div>
                                        <div class="shipping-option-details">
                                            <div class="shipping-option-name">Reguler</div>
                                            <div class="shipping-option-desc">Estimasi 1-2 hari</div>
                                            <div class="shipping-option-price" id="regulerPrice">Rp 0</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="shipping-option" onclick="selectShippingType('express')">
                                    <input type="radio" name="shipping_type_radio" value="express">
                                    <div class="shipping-option-content">
                                        <div class="shipping-option-icon">
                                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                        </div>
                                        <div class="shipping-option-details">
                                            <div class="shipping-option-name">Express</div>
                                            <div class="shipping-option-desc">Estimasi 3-5 jam</div>
                                            <div class="shipping-option-price" id="expressPrice">Rp 0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- âœ… SECTION VOUCHER -->
                        <div class="voucher-section" id="voucherSection">
                            <h3 class="section-subtitle">Voucher Diskon</h3>
                            
                            {% if applied_voucher %}
                            <div class="applied-voucher">
                                <div class="voucher-success">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                    </svg>
                                    <div>
                                        <strong>Voucher {{ applied_voucher.code }} diterapkan!</strong>
                                        <span>Diskon: Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                                    </div>
                                    <button type="button" class="remove-voucher-btn" onclick="removeVoucher()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% else %}
                            <div class="voucher-input-group">
                                <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" maxlength="20">
                                <button type="button" class="btn-apply-voucher" onclick="applyVoucher()">Terapkan</button>
                            </div>
                            <div id="voucherMessage" class="voucher-message"></div>
                            {% endif %}
                        </div>

                        <div class="form-checkbox">
                            <input type="checkbox" id="save_address" name="save_address" value="1">
                            <label for="save_address">Simpan alamat sebagai alamat default untuk pembelian berikutnya</label>
                        </div>

                        <button type="button" class="btn-continue" onclick="showPayment()">Lanjutkan ke Pembayaran</button>
                    </div>

                    <!-- Pembayaran Section (Hidden by default) -->
                    <div class="checkout-section" id="paymentSection" style="display: none;">
                        <h2 class="section-title">Pembayaran</h2>
                        
                        <div class="payment-summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span class="amount">Rp {{ subtotal|format_currency|default:"0" }}</span>
                            </div>
                            
                            {% if applied_voucher %}
                            <div class="summary-row discount-row">
                                <span>Diskon Voucher ({{ applied_voucher.code }})</span>
                                <span class="amount">- Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="summary-row">
                                <span>Biaya Pengiriman (<span id="finalShippingType">Reguler</span>)</span>
                                <span class="amount" id="finalShippingCost">Rp {{ shipping_cost|format_currency }}</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total</span>
                                <span class="amount" id="finalTotal">Rp {{ total|format_currency }}</span>
                            </div>
                        </div>

                        <h3 class="payment-method-title">Metode Pembayaran</h3>

                        <div class="payment-options">
                            <!-- âœ… HANYA MIDTRANS -->
                            <div class="payment-option selected">
                                <div class="payment-card">
                                    <div class="payment-info">
                                        <span class="payment-name">ðŸ’³ Midtrans Payment Gateway</span>
                                        <span class="payment-desc">Virtual Account, E-Wallet, Kartu Kredit, QRIS, dan lainnya</span>
                                    </div>
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="payment-notice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p>Anda akan diarahkan ke halaman pembayaran Midtrans untuk menyelesaikan transaksi dengan berbagai pilihan metode pembayaran yang tersedia.</p>
                        </div>

                        <button type="submit" class="btn-checkout">Lanjutkan ke Pembayaran</button>
                    </div>
                </form>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="checkout-right">
                <div class="order-summary">
                    <h2 class="summary-title">Ringkasan Pesanan</h2>
                    <p class="summary-subtitle">Dijual dan dikirim oleh MancingMo</p>

                    <div class="order-items">
                        {% for item in cart_items %}
                        <div class="order-item">
                            <div class="item-image">
                                {% if item.product.get_main_image %}
                                <img src="{{ item.product.get_main_image }}" alt="{{ item.product.name }}">
                                {% else %}
                                <div class="no-image">No Image</div>
                                {% endif %}
                            </div>
                            <div class="item-details">
                                <h3 class="item-name">{{ item.product.name }}</h3>
                                <p class="item-spec">{{ item.product.description|truncatewords:5 }}</p>
                                <div class="item-footer">
                                    <span class="item-quantity">x {{ item.quantity }}</span>
                                    <span class="item-price">Rp {{ item.get_subtotal|format_currency }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="summary-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span>Rp {{ subtotal|format_currency }}</span>
                        </div>
                        
                        {% if applied_voucher %}
                        <div class="total-row discount-row">
                            <span>Diskon Voucher ({{ applied_voucher.code }})</span>
                            <span>- Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="total-row">
                            <span>Biaya Pengiriman (<span id="summary-shipping-type">Reguler</span>)</span>
                            <span id="summary-shipping">Pilih kecamatan</span>
                        </div>
                        
                        <div class="total-row final">
                            <span>Total</span>
                            <span id="summary-total">Rp {{ total|format_currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Data untuk auto-fill - PRIORITAS: UserProfile > Default Address
const savedAddressData = {
    full_name: "{% if user_profile.address %}{{ user.first_name }} {{ user.last_name }}{% elif default_address %}{{ default_address.full_name }}{% else %}{{ user.first_name }} {{ user.last_name }}{% endif %}",
    phone: "{% if user_profile.phone %}{{ user_profile.phone }}{% elif default_address %}{{ default_address.phone }}{% endif %}",
    address: "{% if user_profile.address %}{{ user_profile.address }}{% elif default_address %}{{ default_address.address }}{% endif %}",
    city: "{% if user_profile.city %}{{ user_profile.city }}{% elif default_address %}{{ default_address.city }}{% endif %}",
    province: "{% if user_profile.province %}{{ user_profile.province }}{% elif default_address %}{{ default_address.province }}{% endif %}",
    district: "{% if user_profile.district %}{{ user_profile.district }}{% elif default_address %}{{ default_address.district }}{% endif %}",
    postal_code: "{% if user_profile.postal_code %}{{ user_profile.postal_code }}{% elif default_address %}{{ default_address.postal_code }}{% endif %}"
};

// HARGA ONGKIR HARDCODE - PASTI BERES!
const shippingCosts = {
    'Biringkanaya': 12000,
    'Bontoala': 8000,
    'Kepulauan Sangkarrang': 25000,
    'Makassar': 9000,
    'Mamajang': 8500,
    'Manggala': 15000,
    'Mariso': 7500,
    'Panakkukang': 11000,
    'Rappocini': 10000,
    'Tallo': 9500,
    'Tamalanrea': 13000,
    'Tamalate': 10500,
    'Ujung Pandang': 7000,
    'Ujung Tanah': 8000,
    'Wajo': 9000,
};

// TAMBAHAN HARGA EXPRESS
const EXPRESS_SURCHARGE = 10000;

// Function to format number to Rupiah - FIXED VERSION dengan titik
function formatRupiah(number) {
    // Pastikan number adalah angka
    const num = parseInt(number);
    if (isNaN(num)) {
        return 'Rp 0';
    }
    
    // Format dengan separator ribuan menggunakan titik
    return 'Rp ' + num.toLocaleString('id-ID').replace(/,/g, '.');
}

// Function untuk parse subtotal dari Django template
function getSubtotal() {
    // Ambil subtotal dari elemen HTML yang sudah diformat
    const subtotalElement = document.querySelector('.summary-totals .total-row:first-child span:last-child');
    if (subtotalElement) {
        const subtotalText = subtotalElement.textContent.replace(/[^\d]/g, '');
        return parseInt(subtotalText) || 0;
    }
    
    // Fallback: parse dari Django template variable
    const djangoSubtotal = parseInt({{ subtotal|default:0 }});
    console.log('Django subtotal parsed:', djangoSubtotal);
    return djangoSubtotal;
}

// Function to select shipping type
function selectShippingType(type) {
    // Update radio buttons
    document.querySelectorAll('.shipping-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`.shipping-option input[value="${type}"]`).parentElement.classList.add('selected');
    
    // Update hidden input
    document.getElementById('shippingType').value = type;
    
    // Update shipping cost display
    updateShippingCostDisplay();
}

// Function to update shipping cost based on selected kecamatan
function updateShippingCost() {
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingCostPreview = document.getElementById('shippingCostPreview');
    const shippingTypeSection = document.getElementById('shippingTypeSection');
    
    console.log('Selected district:', selectedDistrict);
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseShippingCost = shippingCosts[selectedDistrict];
        
        // Update preview
        document.getElementById('shippingCostDisplay').textContent = formatRupiah(baseShippingCost);
        shippingCostPreview.style.display = 'block';
        
        // Show shipping type section
        shippingTypeSection.style.display = 'block';
        
        // Update shipping type prices
        document.getElementById('regulerPrice').textContent = formatRupiah(baseShippingCost);
        document.getElementById('expressPrice').textContent = formatRupiah(baseShippingCost + EXPRESS_SURCHARGE);
        
        // Update summary dengan reguler sebagai default
        updateShippingCostDisplay();
        
        // Enable continue button jika semua field sudah terisi
        checkFormValidity();
    } else {
        shippingCostPreview.style.display = 'none';
        shippingTypeSection.style.display = 'none';
        document.getElementById('summary-shipping').textContent = 'Pilih kecamatan';
        const subtotal = getSubtotal();
        const voucherDiscount = {{ voucher_discount|default:0 }};
        document.getElementById('summary-total').textContent = formatRupiah(subtotal - voucherDiscount);
        
        // Disable continue button
        const continueBtn = document.querySelector('.btn-continue');
        continueBtn.disabled = true;
        continueBtn.style.opacity = '0.5';
        continueBtn.style.cursor = 'not-allowed';
    }
}

// Function to update shipping cost display based on selected type
function updateShippingCostDisplay() {
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingType = document.getElementById('shippingType').value;
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseShippingCost = shippingCosts[selectedDistrict];
        let finalShippingCost = baseShippingCost;
        let shippingTypeName = 'Reguler';
        
        if (shippingType === 'express') {
            finalShippingCost = baseShippingCost + EXPRESS_SURCHARGE;
            shippingTypeName = 'Express';
        }
        
        const subtotal = getSubtotal();
        const voucherDiscount = {{ voucher_discount|default:0 }};
        const total = subtotal + finalShippingCost - voucherDiscount;
        
        console.log('Shipping Type:', shippingType, 'Cost:', finalShippingCost, 'Subtotal:', subtotal, 'Total:', total);
        
        // Update summary
        document.getElementById('summary-shipping-type').textContent = shippingTypeName;
        document.getElementById('summary-shipping').textContent = formatRupiah(finalShippingCost);
        document.getElementById('summary-total').textContent = formatRupiah(total);
        
        // Update payment section jika sudah terbuka
        const finalShippingCostElem = document.getElementById('finalShippingCost');
        const finalTotal = document.getElementById('finalTotal');
        const finalShippingType = document.getElementById('finalShippingType');
        
        if (finalShippingCostElem) {
            finalShippingType.textContent = shippingTypeName;
            finalShippingCostElem.textContent = formatRupiah(finalShippingCost);
            finalTotal.textContent = formatRupiah(total);
        }
    }
}

// Function to check form validity
function checkFormValidity() {
    const fullName = document.getElementById('full_name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const district = document.getElementById('district').value.trim();
    const continueBtn = document.querySelector('.btn-continue');
    
    const isValid = fullName && phone && address && district;
    
    if (isValid) {
        continueBtn.disabled = false;
        continueBtn.style.opacity = '1';
        continueBtn.style.cursor = 'pointer';
    } else {
        continueBtn.disabled = true;
        continueBtn.style.opacity = '0.5';
        continueBtn.style.cursor = 'not-allowed';
    }
    
    return isValid;
}

// Function to use saved address (from profile or default address)
function useSavedAddress() {
    document.getElementById('full_name').value = savedAddressData.full_name || '';
    document.getElementById('phone').value = savedAddressData.phone || '';
    document.getElementById('address').value = savedAddressData.address || '';
    document.getElementById('city').value = savedAddressData.city || 'Makassar';
    document.getElementById('province').value = savedAddressData.province || 'Sulawesi Selatan';
    document.getElementById('postal_code').value = savedAddressData.postal_code || '';
    
    // Set district jika ada
    if (savedAddressData.district) {
        const districtSelect = document.getElementById('district');
        for (let i = 0; i < districtSelect.options.length; i++) {
            if (districtSelect.options[i].value === savedAddressData.district) {
                districtSelect.selectedIndex = i;
                break;
            }
        }
        // Trigger update shipping cost
        updateShippingCost();
    }
    
    // Check form validity setelah auto-fill
    checkFormValidity();
    
    // Remove notice if exists
    const notice = document.querySelector('.address-notice');
    if (notice) {
        notice.remove();
    }
}

// Function to show payment section
function showPayment() {
    const form = document.getElementById('checkoutForm');
    const requiredFields = form.querySelectorAll('.checkout-section:first-child input[required], .checkout-section:first-child textarea[required], .checkout-section:first-child select[required]');
    
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = '#e74c3c';
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            field.style.borderColor = '#ddd';
        }
    });

    // Validasi khusus untuk kecamatan
    const districtSelect = document.getElementById('district');
    if (!districtSelect.value) {
        isValid = false;
        districtSelect.style.borderColor = '#e74c3c';
        districtSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    if (isValid) {
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update final totals di payment section
        updateShippingCostDisplay();
    } else {
        alert('Mohon lengkapi semua data pengiriman yang wajib diisi termasuk kecamatan!');
    }
}

// âœ… VOUCHER FUNCTIONS - TANPA PAGE REFRESH
function applyVoucher() {
    const voucherCode = document.getElementById('voucherCode').value.trim();
    const messageDiv = document.getElementById('voucherMessage');
    
    if (!voucherCode) {
        showVoucherMessage('Kode voucher tidak boleh kosong!', 'error');
        return;
    }
    
    const btn = document.querySelector('.btn-apply-voucher');
    btn.disabled = true;
    btn.textContent = 'Memproses...';
    
    fetch('{% url "apply_voucher_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ voucher_code: voucherCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showVoucherMessage(data.message, 'success');
            // Update UI tanpa reload page
            updateTotalsWithVoucher(data.discount_amount, data.voucher);
        } else {
            showVoucherMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showVoucherMessage('Terjadi kesalahan!', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Terapkan';
    });
}

function removeVoucher() {
    fetch('{% url "remove_voucher_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI tanpa reload page
            updateTotalsWithoutVoucher();
            showVoucherMessage(data.message, 'success');
        } else {
            showVoucherMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showVoucherMessage('Terjadi kesalahan!', 'error');
    });
}

function updateTotalsWithVoucher(discountAmount, voucherData) {
    const subtotal = getSubtotal();
    const shippingCost = getCurrentShippingCost();
    const total = subtotal + shippingCost - discountAmount;
    
    // Update voucher section UI
    const voucherSection = document.getElementById('voucherSection');
    voucherSection.innerHTML = `
        <h3 class="section-subtitle">Voucher Diskon</h3>
        <div class="applied-voucher">
            <div class="voucher-success">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                <div>
                    <strong>Voucher ${voucherData.code} diterapkan!</strong>
                    <span>Diskon: ${formatRupiah(discountAmount)}</span>
                </div>
                <button type="button" class="remove-voucher-btn" onclick="removeVoucher()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    // Update summary totals
    updateSummaryTotals(subtotal, shippingCost, discountAmount);
    
    // Update payment section jika sudah terbuka
    updatePaymentSectionTotals(subtotal, shippingCost, discountAmount);
}

function updateTotalsWithoutVoucher() {
    const subtotal = getSubtotal();
    const shippingCost = getCurrentShippingCost();
    const total = subtotal + shippingCost;
    
    // Reset voucher section UI
    const voucherSection = document.getElementById('voucherSection');
    voucherSection.innerHTML = `
        <h3 class="section-subtitle">Voucher Diskon</h3>
        <div class="voucher-input-group">
            <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" maxlength="20">
            <button type="button" class="btn-apply-voucher" onclick="applyVoucher()">Terapkan</button>
        </div>
        <div id="voucherMessage" class="voucher-message"></div>
    `;
    
    // Update summary totals
    updateSummaryTotals(subtotal, shippingCost, 0);
    
    // Update payment section jika sudah terbuka
    updatePaymentSectionTotals(subtotal, shippingCost, 0);
}

function updateSummaryTotals(subtotal, shippingCost, discountAmount) {
    const total = subtotal + shippingCost - discountAmount;
    
    // Update summary section
    document.querySelector('.summary-totals .total-row:first-child span:last-child').textContent = formatRupiah(subtotal);
    
    // Update discount row
    let discountRow = document.querySelector('.summary-totals .discount-row');
    if (discountAmount > 0) {
        if (!discountRow) {
            // Create discount row jika belum ada
            const subtotalRow = document.querySelector('.summary-totals .total-row:first-child');
            discountRow = document.createElement('div');
            discountRow.className = 'total-row discount-row';
            discountRow.innerHTML = `
                <span>Diskon Voucher</span>
                <span>- ${formatRupiah(discountAmount)}</span>
            `;
            subtotalRow.parentNode.insertBefore(discountRow, subtotalRow.nextSibling);
        } else {
            discountRow.querySelector('span:last-child').textContent = `- ${formatRupiah(discountAmount)}`;
        }
    } else if (discountRow) {
        discountRow.remove();
    }
    
    // Update shipping
    const shippingType = document.getElementById('shippingType').value;
    const shippingTypeName = shippingType === 'express' ? 'Express' : 'Reguler';
    document.getElementById('summary-shipping-type').textContent = shippingTypeName;
    document.getElementById('summary-shipping').textContent = formatRupiah(shippingCost);
    
    // Update total
    document.getElementById('summary-total').textContent = formatRupiah(total);
}

function updatePaymentSectionTotals(subtotal, shippingCost, discountAmount) {
    const total = subtotal + shippingCost - discountAmount;
    const paymentSection = document.getElementById('paymentSection');
    
    if (paymentSection.style.display !== 'none') {
        document.querySelector('.payment-summary .summary-row:first-child .amount').textContent = formatRupiah(subtotal);
        
        // Update discount in payment section
        let paymentDiscountRow = document.querySelector('.payment-summary .discount-row');
        if (discountAmount > 0) {
            if (!paymentDiscountRow) {
                const paymentSubtotalRow = document.querySelector('.payment-summary .summary-row:first-child');
                paymentDiscountRow = document.createElement('div');
                paymentDiscountRow.className = 'summary-row discount-row';
                paymentDiscountRow.innerHTML = `
                    <span>Diskon Voucher</span>
                    <span class="amount">- ${formatRupiah(discountAmount)}</span>
                `;
                paymentSubtotalRow.parentNode.insertBefore(paymentDiscountRow, paymentSubtotalRow.nextSibling);
            } else {
                paymentDiscountRow.querySelector('.amount').textContent = `- ${formatRupiah(discountAmount)}`;
            }
        } else if (paymentDiscountRow) {
            paymentDiscountRow.remove();
        }
        
        document.getElementById('finalShippingCost').textContent = formatRupiah(shippingCost);
        document.getElementById('finalTotal').textContent = formatRupiah(total);
    }
}

function getCurrentShippingCost() {
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingType = document.getElementById('shippingType').value;
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseCost = shippingCosts[selectedDistrict];
        return shippingType === 'express' ? baseCost + EXPRESS_SURCHARGE : baseCost;
    }
    
    return 0;
}

function showVoucherMessage(message, type) {
    const messageDiv = document.getElementById('voucherMessage');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `voucher-message ${type}`;
        
        // Auto-hide success message setelah 3 detik
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = 'voucher-message';
            }, 3000);
        }
    }
}

// Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Reset border color on input/select change
document.querySelectorAll('input, textarea, select').forEach(field => {
    field.addEventListener('input', function() {
        this.style.borderColor = '#ddd';
        checkFormValidity();
    });
    field.addEventListener('change', function() {
        this.style.borderColor = '#ddd';
        checkFormValidity();
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loaded');
    
    // Auto-set city and province to Makassar jika kosong
    const cityField = document.getElementById('city');
    const provinceField = document.getElementById('province');
    
    if (!cityField.value) cityField.value = 'Makassar';
    if (!provinceField.value) provinceField.value = 'Sulawesi Selatan';
    
    // Set initial summary total
    const initialSubtotal = getSubtotal();
    const voucherDiscount = {{ voucher_discount|default:0 }};
    document.getElementById('summary-total').textContent = formatRupiah(initialSubtotal - voucherDiscount);
    
    // Trigger update shipping cost if district is pre-selected
    const districtSelect = document.getElementById('district');
    if (districtSelect.value) {
        console.log('District pre-selected:', districtSelect.value);
        updateShippingCost();
    }
    
    // Check form validity on load
    checkFormValidity();
    
    // Debug: Log initial values
    console.log('Initial subtotal calculated:', initialSubtotal);
    console.log('Voucher discount:', voucherDiscount);
});
</script>

{% endblock %}