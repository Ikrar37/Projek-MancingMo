{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Checkout - MancingMo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
<style>
/* Voucher Styles */
.voucher-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.section-subtitle {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #333;
}

.voucher-input-group {
    display: flex;
    gap: 10px;
}

#voucherCode {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

#voucherCode:focus {
    outline: none;
    border-color: #4285f4;
}

.btn-apply-voucher {
    padding: 12px 20px;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
}

.btn-apply-voucher:hover {
    background: #3367d6;
}

.btn-apply-voucher:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.voucher-message {
    margin-top: 8px;
    font-size: 14px;
    min-height: 20px;
    padding: 8px 12px;
    border-radius: 4px;
    font-weight: 500;
}

.voucher-message.success {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.voucher-message.error {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.voucher-message:empty {
    display: none;
}

.applied-voucher {
    margin-top: 10px;
}

.voucher-success {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 6px;
    color: #155724;
}

.voucher-success > div {
    flex: 1;
    margin-left: 10px;
}

.voucher-success strong {
    display: block;
    margin-bottom: 2px;
}

.remove-voucher-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.remove-voucher-btn:hover {
    background: rgba(220, 53, 69, 0.1);
}

.discount-row {
    color: #28a745;
}

.discount-row .amount {
    color: #28a745;
    font-weight: 600;
}

.shipping-cost-preview {
    margin: 15px 0;
    transition: all 0.3s ease;
}

.shipping-cost-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    color: #155724;
    transition: all 0.3s ease;
}

/* Style untuk express shipping */
.shipping-cost-card.express {
    background: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.shipping-cost-card svg {
    flex-shrink: 0;
}

.shipping-cost-card div {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #6b7280;
}

#district {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background-color: white;
}

#district:focus {
    outline: none;
    border-color: #4285f4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

.shipping-type-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.shipping-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.shipping-option {
    flex: 1;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.shipping-option:hover {
    border-color: #4285f4;
}

.shipping-option.selected {
    border-color: #4285f4;
    background: #f0f7ff;
}

.shipping-option input {
    display: none;
}

.shipping-option-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.shipping-option-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.shipping-option-details {
    flex: 1;
}

.shipping-option-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
}

.shipping-option-desc {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.shipping-option-price {
    font-weight: 600;
    color: #4285f4;
}

.btn-continue {
    width: 100%;
    padding: 15px;
    background-color: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.btn-continue:hover:not(:disabled) {
    background-color: #3367d6;
    transform: translateY(-2px);
}

.btn-continue:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
}

.input-error {
    border-color: #e74c3c !important;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
}

/* ‚úÖ STYLE BARU UNTUK SHIPPING METHOD */
.shipping-method-section {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #fafafa;
}

.shipping-method-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.shipping-method-option {
    flex: 1;
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    text-align: center;
}

.shipping-method-option:hover {
    border-color: #4285f4;
}

.shipping-method-option.selected {
    border-color: #4285f4;
    background: #f0f7ff;
}

.shipping-method-option input {
    display: none;
}

.shipping-method-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.shipping-method-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #4285f4;
    border-radius: 50%;
    color: white;
}

.shipping-method-details {
    text-align: center;
}

.shipping-method-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
    font-size: 16px;
}

.shipping-method-desc {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.shipping-method-price {
    font-weight: 600;
    color: #28a745;
    font-size: 18px;
}

.pickup-info {
    display: none;
    padding: 15px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    margin: 15px 0;
    color: #155724;
}

.pickup-info.show {
    display: block;
}

.pickup-address {
    font-weight: 600;
    margin-top: 8px;
}

.delivery-fields {
    transition: all 0.3s ease;
}

/* Style untuk tombol Gunakan Alamat Default */
.use-saved-address-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.use-saved-address-btn:hover {
    background: #3367d6;
    transform: translateY(-1px);
}

.use-saved-address-btn:active {
    transform: translateY(0);
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="checkout-hero">
    <div class="container">
        <a href="{% if is_buy_now %}javascript:history.back(){% else %}{% url 'cart' %}{% endif %}" class="back-button">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="page-title">Check Out</h1>
        <div class="breadcrumb">
            <a href="{% url 'home' %}">Home</a>
            <span class="separator">‚Ä∫</span>
            {% if not is_buy_now %}
            <a href="{% url 'cart' %}">Cart</a>
            <span class="separator">‚Ä∫</span>
            {% endif %}
            <span class="current">Check Out</span>
        </div>
    </div>
</section>

<!-- Checkout Content -->
<section class="checkout-content">
    <div class="container">
        <div class="checkout-grid">
            <!-- Left Column - Shipping & Payment Info -->
            <div class="checkout-left">
                <form method="POST" id="checkoutForm">
                    {% csrf_token %}
                    
                    <!-- Hidden inputs -->
                    {% if not is_buy_now %}
                        {% for item in cart_items %}
                        <input type="hidden" name="selected_items" value="{{ item.id }}">
                        {% endfor %}
                    {% endif %}
                    
                    <input type="hidden" name="payment_method" value="midtrans">
                    <input type="hidden" name="shipping_type" id="shippingType" value="{{ shipping_type }}">
                    <input type="hidden" name="shipping_method" id="shippingMethod" value="{{ shipping_method }}">
                    
                    <!-- ‚úÖ SECTION METODE PENGIRIMAN BARU -->
                    <div class="shipping-method-section">
                        <h2 class="section-title">Metode Pengiriman</h2>
                        
                        <div class="shipping-method-options">
                            <div class="shipping-method-option {% if shipping_method == 'delivery' %}selected{% endif %}" onclick="selectShippingMethod('delivery')">
                                <input type="radio" name="shipping_method_radio" value="delivery" {% if shipping_method == 'delivery' %}checked{% endif %}>
                                <div class="shipping-method-content">
                                    <div class="shipping-method-icon">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                        </svg>
                                    </div>
                                    <div class="shipping-method-details">
                                        <div class="shipping-method-name">Delivery</div>
                                        <div class="shipping-method-desc">Pesanan dikirim ke alamat Anda</div>
                                        <div class="shipping-method-price" id="deliveryPrice">Mulai Rp 7.000</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="shipping-method-option {% if shipping_method == 'pickup' %}selected{% endif %}" onclick="selectShippingMethod('pickup')">
                                <input type="radio" name="shipping_method_radio" value="pickup" {% if shipping_method == 'pickup' %}checked{% endif %}>
                                <div class="shipping-method-content">
                                    <div class="shipping-method-icon">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                                        </svg>
                                    </div>
                                    <div class="shipping-method-details">
                                        <div class="shipping-method-name">Pick Up</div>
                                        <div class="shipping-method-desc">Ambil sendiri di toko</div>
                                        <div class="shipping-method-price">GRATIS</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Pengiriman -->
                    <div class="checkout-section">
                        <h2 class="section-title">Info Pengiriman</h2>
                        
                        <!-- Pickup Info -->
                        <div class="pickup-info" id="pickupInfo">
                            <strong>üìç Ambil Pesanan di:</strong>
                            <div class="pickup-address">
                                Jl. Sanrangan, Sudiang Raya<br>
                                Kecamatan Biringkanaya, Makassar<br>
                                Sulawesi Selatan 90242<br>
                                <small>üìû Hubungi: 0812-5362-1738</small>
                            </div>
                        </div>

                        <div class="login-status">
                            <div>
                                <p class="status-text">Masuk sebagai</p>
                                <p class="status-value">{{ user.first_name }} {{ user.last_name }}</p>
                            </div>
                            {% if user_profile.address or default_address %}
                            <button type="button" class="use-saved-address-btn" onclick="useSavedAddress()" id="useSavedAddressBtn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Gunakan Alamat Default
                            </button>
                            {% endif %}
                        </div>

                        {% if not user_profile.address and not default_address %}
                        <div class="address-notice" id="addressNotice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <p>Anda belum menyimpan alamat. Lengkapi form di bawah atau <a href="{% url 'edit_profile' %}">perbarui profil</a> Anda.</p>
                        </div>
                        {% endif %}

                        <!-- ‚úÖ DIPERBAIKI: Form fields KOSONG awalnya -->
                        <div class="form-group">
                            <label for="full_name">Nama Lengkap *</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Masukkan nama lengkap" value="" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Nomor Telepon *</label>
                            <input type="tel" id="phone" name="phone" placeholder="Contoh: 08123456789" value="" required>
                        </div>

                        <!-- Delivery Address Fields -->
                        <div class="delivery-fields" id="deliveryAddressFields">
                            <div class="form-group">
                                <label for="address">Alamat Lengkap *</label>
                                <textarea id="address" name="address" rows="3" placeholder="Jl. Contoh No. 123, RT/RW, Kelurahan, Kecamatan"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">Kota *</label>
                                    <input type="text" id="city" name="city" placeholder="Contoh: Makassar" value="" readonly style="background-color: #f5f5f5;">
                                    <small class="form-help">Saat ini hanya melayani pengiriman di Makassar</small>
                                </div>
                                <div class="form-group">
                                    <label for="province">Provinsi *</label>
                                    <input type="text" id="province" name="province" placeholder="Contoh: Sulawesi Selatan" value="" readonly style="background-color: #f5f5f5;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="district">Kecamatan *</label>
                                <select id="district" name="district">
                                    <option value="">Pilih Kecamatan</option>
                                    {% for kecamatan in kecamatan_list %}
                                    <option value="{{ kecamatan.kecamatan }}">
                                        {{ kecamatan.kecamatan }} - Rp {{ kecamatan.harga|format_currency }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-help">Pilih kecamatan untuk melihat biaya pengiriman</small>
                            </div>

                            <div class="form-group">
                                <label for="postal_code">Kode Pos (Opsional)</label>
                                <input type="text" id="postal_code" name="postal_code" placeholder="90123" value="">
                            </div>

                            <!-- Shipping Cost Preview -->
                            <div class="shipping-cost-preview" id="shippingCostPreview" style="display: none;">
                                <div class="shipping-cost-card" id="shippingCostCard">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                    </svg>
                                    <div>
                                        <strong id="shippingCostLabel">Biaya Pengiriman Reguler:</strong>
                                        <span id="shippingCostDisplay">Rp 0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Type Section -->
                            <div class="shipping-type-section" id="shippingTypeSection" style="display: none;">
                                <h3 class="section-subtitle">Jenis Pengiriman</h3>
                                
                                <div class="shipping-options">
                                    <div class="shipping-option selected" onclick="selectShippingType('reguler')">
                                        <input type="radio" name="shipping_type_radio" value="reguler" checked>
                                        <div class="shipping-option-content">
                                            <div class="shipping-option-icon">
                                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                                </svg>
                                            </div>
                                            <div class="shipping-option-details">
                                                <div class="shipping-option-name">Reguler</div>
                                                <div class="shipping-option-desc">Estimasi 1-2 hari</div>
                                                <div class="shipping-option-price" id="regulerPrice">Rp 0</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="shipping-option" onclick="selectShippingType('express')">
                                        <input type="radio" name="shipping_type_radio" value="express">
                                        <div class="shipping-option-content">
                                            <div class="shipping-option-icon">
                                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                                </svg>
                                            </div>
                                            <div class="shipping-option-details">
                                                <div class="shipping-option-name">Express</div>
                                                <div class="shipping-option-desc">Estimasi 3-5 jam</div>
                                                <div class="shipping-option-price" id="expressPrice">Rp 0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‚úÖ SECTION VOUCHER -->
                        <div class="voucher-section" id="voucherSection">
                            <h3 class="section-subtitle">Voucher Diskon</h3>
                            
                            {% if applied_voucher %}
                            <div class="applied-voucher">
                                <div class="voucher-success">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                    </svg>
                                    <div>
                                        <strong>Voucher {{ applied_voucher.code }} diterapkan!</strong>
                                        <span>Diskon: Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                                    </div>
                                    <button type="button" class="remove-voucher-btn" onclick="removeVoucher()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% else %}
                            <div class="voucher-input-group">
                                <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" maxlength="20" value="">
                                <button type="button" class="btn-apply-voucher" onclick="applyVoucher()">Terapkan</button>
                            </div>
                            <div id="voucherMessage" class="voucher-message"></div>
                            {% endif %}
                        </div>

                        <div class="form-checkbox" id="saveAddressCheckbox">
                            <input type="checkbox" id="save_address" name="save_address" value="1">
                            <label for="save_address">Simpan alamat sebagai alamat default untuk pembelian berikutnya</label>
                        </div>

                        <button type="button" class="btn-continue" onclick="showPayment()">Lanjutkan ke Pembayaran</button>
                    </div>

                    <!-- Pembayaran Section -->
                    <div class="checkout-section" id="paymentSection" style="display: none;">
                        <h2 class="section-title">Pembayaran</h2>
                        
                        <div class="payment-summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span class="amount">Rp {{ subtotal|format_currency|default:"0" }}</span>
                            </div>
                            
                            {% if applied_voucher %}
                            <div class="summary-row discount-row">
                                <span>Diskon Voucher ({{ applied_voucher.code }})</span>
                                <span class="amount">- Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="summary-row">
                                <span>Biaya Pengiriman (<span id="finalShippingType">Reguler</span>)</span>
                                <span class="amount" id="finalShippingCost">Rp {{ shipping_cost|format_currency }}</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total</span>
                                <span class="amount" id="finalTotal">Rp {{ total|format_currency }}</span>
                            </div>
                        </div>

                        <h3 class="payment-method-title">Metode Pembayaran</h3>

                        <div class="payment-options">
                            <div class="payment-option selected">
                                <div class="payment-card">
                                    <div class="payment-info">
                                        <span class="payment-name">üí≥ Midtrans Payment Gateway</span>
                                        <span class="payment-desc">Virtual Account, E-Wallet, Kartu Kredit, QRIS, dan lainnya</span>
                                    </div>
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="payment-notice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p>Anda akan diarahkan ke halaman pembayaran Midtrans untuk menyelesaikan transaksi dengan berbagai pilihan metode pembayaran yang tersedia.</p>
                        </div>

                        <button type="submit" class="btn-checkout">Lanjutkan ke Pembayaran</button>
                    </div>
                </form>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="checkout-right">
                <div class="order-summary">
                    <h2 class="summary-title">Ringkasan Pesanan</h2>
                    <p class="summary-subtitle">Dijual dan dikirim oleh MancingMo</p>

                    <div class="order-items">
                        {% for item in cart_items %}
                        <div class="order-item">
                            <div class="item-image">
                                {% if item.product.get_main_image %}
                                <img src="{{ item.product.get_main_image }}" alt="{{ item.product.name }}">
                                {% else %}
                                <div class="no-image">No Image</div>
                                {% endif %}
                            </div>
                            <div class="item-details">
                                <h3 class="item-name">{{ item.product.name }}</h3>
                                <p class="item-spec">{{ item.product.description|truncatewords:5 }}</p>
                                <div class="item-footer">
                                    <span class="item-quantity">x {{ item.quantity }}</span>
                                    <span class="item-price">Rp {{ item.get_subtotal|format_currency }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="summary-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span>Rp {{ subtotal|format_currency }}</span>
                        </div>
                        
                        {% if applied_voucher %}
                        <div class="total-row discount-row">
                            <span>Diskon Voucher ({{ applied_voucher.code }})</span>
                            <span>- Rp {{ applied_voucher.discount_amount|format_currency }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="total-row">
                            <span>Biaya Pengiriman (<span id="summary-shipping-type">Reguler</span>)</span>
                            <span id="summary-shipping">Pilih metode pengiriman</span>
                        </div>
                        
                        <div class="total-row final">
                            <span>Total</span>
                            <span id="summary-total">Rp {{ total|format_currency }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// ‚úÖ DIPERBAIKI: Data untuk auto-fill - Kosongkan nilai default
const savedAddressData = {
    full_name: "{{ user.first_name }} {{ user.last_name }}",
    phone: "{% if user_profile.phone %}{{ user_profile.phone }}{% elif default_address %}{{ default_address.phone }}{% endif %}",
    address: "{% if user_profile.address %}{{ user_profile.address }}{% elif default_address %}{{ default_address.address }}{% endif %}",
    city: "{% if user_profile.city %}{{ user_profile.city }}{% elif default_address %}{{ default_address.city }}{% endif %}",
    province: "{% if user_profile.province %}{{ user_profile.province }}{% elif default_address %}{{ default_address.province }}{% endif %}",
    district: "{% if user_profile.district %}{{ user_profile.district }}{% elif default_address %}{{ default_address.district }}{% endif %}",
    postal_code: "{% if user_profile.postal_code %}{{ user_profile.postal_code }}{% elif default_address %}{{ default_address.postal_code }}{% endif %}"
};

// HARGA ONGKIR
const shippingCosts = {
    'Biringkanaya': 12000,
    'Bontoala': 8000,
    'Kepulauan Sangkarrang': 25000,
    'Makassar': 9000,
    'Mamajang': 8500,
    'Manggala': 15000,
    'Mariso': 7500,
    'Panakkukang': 11000,
    'Rappocini': 10000,
    'Tallo': 9500,
    'Tamalanrea': 13000,
    'Tamalate': 10500,
    'Ujung Pandang': 7000,
    'Ujung Tanah': 8000,
    'Wajo': 9000,
};

const EXPRESS_SURCHARGE = 10000;

// Function to format number to Rupiah
function formatRupiah(number) {
    const num = parseInt(number);
    if (isNaN(num)) {
        return 'Rp 0';
    }
    return 'Rp ' + num.toLocaleString('id-ID').replace(/,/g, '.');
}

// Function untuk parse subtotal dari Django template
function getSubtotal() {
    const subtotalElement = document.querySelector('.summary-totals .total-row:first-child span:last-child');
    if (subtotalElement) {
        const subtotalText = subtotalElement.textContent.replace(/[^\d]/g, '');
        return parseInt(subtotalText) || 0;
    }
    return parseInt({{ subtotal|default:0 }});
}

// ‚úÖ SIMPLE VOUCHER MANAGEMENT
let currentVoucher = {% if applied_voucher %}{
    code: '{{ applied_voucher.code }}',
    discount_amount: {{ applied_voucher.discount_amount|default:0 }}
} {% else %} null {% endif %};

// ‚úÖ FUNCTION BARU: Select Shipping Method
function selectShippingMethod(method) {
    document.querySelectorAll('.shipping-method-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`.shipping-method-option input[value="${method}"]`).parentElement.classList.add('selected');
    
    document.getElementById('shippingMethod').value = method;
    
    const deliveryFields = document.getElementById('deliveryAddressFields');
    const pickupInfo = document.getElementById('pickupInfo');
    
    if (method === 'delivery') {
        deliveryFields.style.display = 'block';
        pickupInfo.classList.remove('show');
        selectShippingType('reguler');
        updateShippingCost();
    } else {
        deliveryFields.style.display = 'none';
        pickupInfo.classList.add('show');
        updateSummaryForPickup();
    }
    
    checkFormValidity();
}

// ‚úÖ FUNCTION BARU: Update summary untuk pickup
function updateSummaryForPickup() {
    const subtotal = getSubtotal();
    const discountAmount = currentVoucher ? currentVoucher.discount_amount : 0;
    const total = subtotal - discountAmount;
    
    document.getElementById('summary-shipping-type').textContent = 'Pick Up';
    document.getElementById('summary-shipping').textContent = 'GRATIS';
    document.getElementById('summary-total').textContent = formatRupiah(total);
    
    updatePaymentSectionTotals(subtotal, 0, discountAmount);
}

// ‚úÖ FUNCTION: Update shipping cost
function updateShippingCost() {
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingCostPreview = document.getElementById('shippingCostPreview');
    const shippingTypeSection = document.getElementById('shippingTypeSection');
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseShippingCost = shippingCosts[selectedDistrict];
        const shippingType = document.getElementById('shippingType').value;
        let displayShippingCost = baseShippingCost;
        let shippingTypeName = 'Reguler';
        
        if (shippingType === 'express') {
            displayShippingCost = baseShippingCost + EXPRESS_SURCHARGE;
            shippingTypeName = 'Express';
        }
        
        document.getElementById('shippingCostDisplay').textContent = formatRupiah(displayShippingCost);
        document.getElementById('shippingCostLabel').textContent = `Biaya Pengiriman ${shippingTypeName}:`;
        
        const shippingCostCard = document.getElementById('shippingCostCard');
        if (shippingType === 'express') {
            shippingCostCard.classList.add('express');
        } else {
            shippingCostCard.classList.remove('express');
        }
        
        shippingCostPreview.style.display = 'block';
        shippingTypeSection.style.display = 'block';
        
        document.getElementById('regulerPrice').textContent = formatRupiah(baseShippingCost);
        document.getElementById('expressPrice').textContent = formatRupiah(baseShippingCost + EXPRESS_SURCHARGE);
        
        updateShippingCostDisplay();
        checkFormValidity();
    } else {
        shippingCostPreview.style.display = 'none';
        shippingTypeSection.style.display = 'none';
        document.getElementById('summary-shipping').textContent = 'Pilih kecamatan';
        updateTotals();
    }
}

// ‚úÖ FUNCTION: Update shipping cost display
function updateShippingCostDisplay() {
    const shippingMethod = document.getElementById('shippingMethod').value;
    
    if (shippingMethod === 'pickup') {
        updateSummaryForPickup();
        return;
    }
    
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingType = document.getElementById('shippingType').value;
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseShippingCost = shippingCosts[selectedDistrict];
        let finalShippingCost = baseShippingCost;
        let shippingTypeName = 'Reguler';
        
        if (shippingType === 'express') {
            finalShippingCost = baseShippingCost + EXPRESS_SURCHARGE;
            shippingTypeName = 'Express';
        }
        
        updateTotals(finalShippingCost);
        
        document.getElementById('shippingCostDisplay').textContent = formatRupiah(finalShippingCost);
        document.getElementById('shippingCostLabel').textContent = `Biaya Pengiriman ${shippingTypeName}:`;
        
        const shippingCostCard = document.getElementById('shippingCostCard');
        if (shippingType === 'express') {
            shippingCostCard.classList.add('express');
        } else {
            shippingCostCard.classList.remove('express');
        }
    }
}

// ‚úÖ FUNCTION: Select shipping type
function selectShippingType(type) {
    document.querySelectorAll('.shipping-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`.shipping-option input[value="${type}"]`).parentElement.classList.add('selected');
    
    document.getElementById('shippingType').value = type;
    updateShippingCost();
}

// ‚úÖ FUNCTION: Check form validity
function checkFormValidity() {
    const shippingMethod = document.getElementById('shippingMethod').value;
    const fullName = document.getElementById('full_name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const continueBtn = document.querySelector('.btn-continue');
    
    let isValid = fullName && phone;
    
    if (shippingMethod === 'delivery') {
        const address = document.getElementById('address').value.trim();
        const district = document.getElementById('district').value.trim();
        isValid = isValid && address && district;
    }
    
    if (continueBtn) {
        continueBtn.disabled = !isValid;
        continueBtn.style.opacity = isValid ? '1' : '0.5';
        continueBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
    }
    
    return isValid;
}

// ‚úÖ FUNCTION: Use saved address - DIPERBAIKI
function useSavedAddress() {
    const shippingMethod = document.getElementById('shippingMethod').value;
    
    // Isi form dengan data alamat default
    document.getElementById('full_name').value = savedAddressData.full_name || '';
    document.getElementById('phone').value = savedAddressData.phone || '';
    
    if (shippingMethod === 'delivery') {
        document.getElementById('address').value = savedAddressData.address || '';
        document.getElementById('city').value = savedAddressData.city || 'Makassar';
        document.getElementById('province').value = savedAddressData.province || 'Sulawesi Selatan';
        document.getElementById('postal_code').value = savedAddressData.postal_code || '';
        
        if (savedAddressData.district) {
            const districtSelect = document.getElementById('district');
            for (let i = 0; i < districtSelect.options.length; i++) {
                if (districtSelect.options[i].value === savedAddressData.district) {
                    districtSelect.selectedIndex = i;
                    break;
                }
            }
            setTimeout(() => updateShippingCost(), 100);
        }
        
        const notice = document.querySelector('.address-notice');
        if (notice) notice.remove();
    }
    
    checkFormValidity();
    
    // Tampilkan pesan sukses
    showVoucherMessage('Alamat default berhasil diisi!', 'success');
}

// ‚úÖ FUNCTION: Show payment section
function showPayment() {
    if (!checkFormValidity()) {
        alert('Mohon lengkapi semua data yang wajib diisi!');
        return;
    }

    document.getElementById('paymentSection').style.display = 'block';
    document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // ‚úÖ PASTIKAN: Update totals sebelum menampilkan payment section
    const shippingCost = getCurrentShippingCost();
    const subtotal = getSubtotal();
    const discountAmount = currentVoucher ? currentVoucher.discount_amount : 0;
    updatePaymentSectionTotals(subtotal, shippingCost, discountAmount);
}

// ‚úÖ SIMPLE VOUCHER FUNCTIONS
function applyVoucher() {
    const voucherCode = document.getElementById('voucherCode').value.trim();
    const messageDiv = document.getElementById('voucherMessage');
    
    if (!voucherCode) {
        showVoucherMessage('Kode voucher tidak boleh kosong!', 'error');
        return;
    }
    
    const btn = document.querySelector('.btn-apply-voucher');
    btn.disabled = true;
    btn.textContent = 'Memproses...';
    
    fetch('{% url "apply_voucher_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ voucher_code: voucherCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentVoucher = {
                code: data.voucher.code,
                discount_amount: data.discount_amount
            };
            showVoucherMessage(data.message, 'success');
            updateTotals();
            updateVoucherUI();
        } else {
            showVoucherMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showVoucherMessage('Terjadi kesalahan!', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Terapkan';
    });
}

function removeVoucher() {
    fetch('{% url "remove_voucher_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentVoucher = null;
            updateTotals();
            updateVoucherUI();
            showVoucherMessage(data.message, 'success');
        } else {
            showVoucherMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showVoucherMessage('Terjadi kesalahan!', 'error');
    });
}

// ‚úÖ FUNCTION: Update voucher UI
function updateVoucherUI() {
    const voucherSection = document.getElementById('voucherSection');
    
    if (currentVoucher) {
        voucherSection.innerHTML = `
            <h3 class="section-subtitle">Voucher Diskon</h3>
            <div class="applied-voucher">
                <div class="voucher-success">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <div>
                        <strong>Voucher ${currentVoucher.code} diterapkan!</strong>
                        <span>Diskon: ${formatRupiah(currentVoucher.discount_amount)}</span>
                    </div>
                    <button type="button" class="remove-voucher-btn" onclick="removeVoucher()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    } else {
        voucherSection.innerHTML = `
            <h3 class="section-subtitle">Voucher Diskon</h3>
            <div class="voucher-input-group">
                <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" maxlength="20">
                <button type="button" class="btn-apply-voucher" onclick="applyVoucher()">Terapkan</button>
            </div>
            <div id="voucherMessage" class="voucher-message"></div>
        `;
    }
}

// ‚úÖ FUNCTION: Update all totals
function updateTotals(shippingCost = null) {
    const subtotal = getSubtotal();
    const finalShippingCost = shippingCost !== null ? shippingCost : getCurrentShippingCost();
    const discountAmount = currentVoucher ? currentVoucher.discount_amount : 0;
    const total = subtotal + finalShippingCost - discountAmount;
    
    updateSummaryTotals(subtotal, finalShippingCost, discountAmount);
    updatePaymentSectionTotals(subtotal, finalShippingCost, discountAmount);
}

// ‚úÖ FUNCTION: Update summary totals
function updateSummaryTotals(subtotal, shippingCost, discountAmount) {
    const total = subtotal + shippingCost - discountAmount;
    const shippingMethod = document.getElementById('shippingMethod').value;
    const shippingType = document.getElementById('shippingType').value;
    
    // Update subtotal
    const subtotalElement = document.querySelector('.summary-totals .total-row:first-child span:last-child');
    if (subtotalElement) {
        subtotalElement.textContent = formatRupiah(subtotal);
    }
    
    // Update discount row
    let discountRow = document.querySelector('.summary-totals .discount-row');
    if (discountAmount > 0 && currentVoucher) {
        if (!discountRow) {
            const subtotalRow = document.querySelector('.summary-totals .total-row:first-child');
            discountRow = document.createElement('div');
            discountRow.className = 'total-row discount-row';
            discountRow.innerHTML = `
                <span>Diskon Voucher (${currentVoucher.code})</span>
                <span>- ${formatRupiah(discountAmount)}</span>
            `;
            if (subtotalRow && subtotalRow.parentNode) {
                subtotalRow.parentNode.insertBefore(discountRow, subtotalRow.nextSibling);
            }
        }
    } else if (discountRow) {
        discountRow.remove();
    }
    
    // Update shipping
    let shippingTypeName = 'Reguler';
    if (shippingMethod === 'pickup') {
        shippingTypeName = 'Pick Up';
        document.getElementById('summary-shipping').textContent = 'GRATIS';
    } else {
        if (shippingType === 'express') {
            shippingTypeName = 'Express';
        }
        document.getElementById('summary-shipping').textContent = formatRupiah(shippingCost);
    }
    
    document.getElementById('summary-shipping-type').textContent = shippingTypeName;
    document.getElementById('summary-total').textContent = formatRupiah(total);
}

// ‚úÖ FUNCTION: Update payment section totals
function updatePaymentSectionTotals(subtotal, shippingCost, discountAmount) {
    const total = subtotal + shippingCost - discountAmount;
    const paymentSection = document.getElementById('paymentSection');
    const shippingMethod = document.getElementById('shippingMethod').value;
    const shippingType = document.getElementById('shippingType').value;
    
    if (paymentSection.style.display !== 'none') {
        // Update subtotal
        const paymentSubtotalElement = document.querySelector('.payment-summary .summary-row:first-child .amount');
        if (paymentSubtotalElement) {
            paymentSubtotalElement.textContent = formatRupiah(subtotal);
        }
        
        // Update discount
        let paymentDiscountRow = document.querySelector('.payment-summary .discount-row');
        if (discountAmount > 0 && currentVoucher) {
            if (!paymentDiscountRow) {
                const paymentSubtotalRow = document.querySelector('.payment-summary .summary-row:first-child');
                paymentDiscountRow = document.createElement('div');
                paymentDiscountRow.className = 'summary-row discount-row';
                paymentDiscountRow.innerHTML = `
                    <span>Diskon Voucher (${currentVoucher.code})</span>
                    <span class="amount">- ${formatRupiah(discountAmount)}</span>
                `;
                if (paymentSubtotalRow && paymentSubtotalRow.parentNode) {
                    paymentSubtotalRow.parentNode.insertBefore(paymentDiscountRow, paymentSubtotalRow.nextSibling);
                }
            }
        } else if (paymentDiscountRow) {
            paymentDiscountRow.remove();
        }
        
        // Update shipping
        let shippingTypeName = 'Reguler';
        if (shippingMethod === 'pickup') {
            shippingTypeName = 'Pick Up';
            document.getElementById('finalShippingCost').textContent = 'GRATIS';
        } else {
            if (shippingType === 'express') {
                shippingTypeName = 'Express';
            }
            document.getElementById('finalShippingCost').textContent = formatRupiah(shippingCost);
        }
        
        document.getElementById('finalShippingType').textContent = shippingTypeName;
        document.getElementById('finalTotal').textContent = formatRupiah(total);
    }
}

function getCurrentShippingCost() {
    const shippingMethod = document.getElementById('shippingMethod').value;
    
    if (shippingMethod === 'pickup') {
        return 0;
    }
    
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingType = document.getElementById('shippingType').value;
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const baseCost = shippingCosts[selectedDistrict];
        return shippingType === 'express' ? baseCost + EXPRESS_SURCHARGE : baseCost;
    }
    
    return 0;
}

function showVoucherMessage(message, type) {
    const messageDiv = document.getElementById('voucherMessage');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `voucher-message ${type}`;
        
        if (type === 'success') {
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = 'voucher-message';
            }, 3000);
        }
    }
}

// Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Event listeners
document.querySelectorAll('input, textarea, select').forEach(field => {
    field.addEventListener('input', function() {
        this.classList.remove('input-error');
        checkFormValidity();
        if (this.id === 'district') updateShippingCost();
    });
    field.addEventListener('change', function() {
        this.classList.remove('input-error');
        checkFormValidity();
        if (this.id === 'district') updateShippingCost();
    });
});

// ‚úÖ DIPERBAIKI: Initialize dengan form kosong
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loaded');
    
    // Initialize voucher UI
    updateVoucherUI();
    
    // ‚úÖ DIPERBAIKI: Auto-set city dan province TANPA mengisi field lain
    const cityField = document.getElementById('city');
    const provinceField = document.getElementById('province');
    if (cityField && !cityField.value) cityField.value = 'Makassar';
    if (provinceField && !provinceField.value) provinceField.value = 'Sulawesi Selatan';
    
    // ‚úÖ DIPERBAIKI: Kosongkan field lainnya
    document.getElementById('full_name').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('address').value = '';
    document.getElementById('district').selectedIndex = 0;
    document.getElementById('postal_code').value = '';
    
    // Initialize shipping method
    const initialShippingMethod = '{{ shipping_method }}';
    selectShippingMethod(initialShippingMethod);
    
    // Add event listeners
    document.querySelectorAll('input[name="shipping_type_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectShippingType(this.value);
        });
    });
    
    // Initialize shipping cost if delivery
    if (initialShippingMethod === 'delivery') {
        const districtSelect = document.getElementById('district');
        if (districtSelect.value) {
            setTimeout(() => updateShippingCost(), 500);
        }
        districtSelect.addEventListener('change', function() {
            updateShippingCost();
        });
    }
    
    // Initial totals update
    updateTotals();
    checkFormValidity();
});
</script>

{% endblock %}