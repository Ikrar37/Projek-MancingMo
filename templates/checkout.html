{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Checkout - MancingMo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="checkout-hero">
    <div class="container">
        <a href="{% if is_buy_now %}javascript:history.back(){% else %}{% url 'cart' %}{% endif %}" class="back-button">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="page-title">Check Out</h1>
        <div class="breadcrumb">
            <a href="{% url 'home' %}">Home</a>
            <span class="separator">â€º</span>
            {% if not is_buy_now %}
            <a href="{% url 'cart' %}">Cart</a>
            <span class="separator">â€º</span>
            {% endif %}
            <span class="current">Check Out</span>
        </div>
    </div>
</section>

<!-- Checkout Content -->
<section class="checkout-content">
    <div class="container">
        <div class="checkout-grid">
            <!-- Left Column - Shipping & Payment Info -->
            <div class="checkout-left">
                <form method="POST" id="checkoutForm">
                    {% csrf_token %}
                    
                    <!-- Hidden inputs untuk selected items (hanya untuk mode cart) -->
                    {% if not is_buy_now %}
                        {% for item in cart_items %}
                        <input type="hidden" name="selected_items" value="{{ item.id }}">
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Hidden input untuk payment method (hanya midtrans) -->
                    <input type="hidden" name="payment_method" value="midtrans">
                    
                    <!-- Info Pengiriman -->
                    <div class="checkout-section">
                        <h2 class="section-title">Info Pengiriman</h2>
                        
                        <div class="login-status">
                            <div>
                                <p class="status-text">Masuk sebagai</p>
                                <p class="status-value">{{ user.first_name }} {{ user.last_name }}</p>
                            </div>
                            {% if user_profile.address or default_address %}
                            <button type="button" class="use-saved-address-btn" onclick="useSavedAddress()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Gunakan Alamat Default
                            </button>
                            {% endif %}
                        </div>

                        {% if not user_profile.address and not default_address %}
                        <div class="address-notice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <p>Anda belum menyimpan alamat. Lengkapi form di bawah atau <a href="{% url 'edit_profile' %}">perbarui profil</a> Anda.</p>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="full_name">Nama Lengkap *</label>
                            <input type="text" id="full_name" name="full_name" placeholder="Masukkan nama lengkap" 
                                   value="{% if user_profile.address %}{{ user.first_name }} {{ user.last_name }}{% elif default_address %}{{ default_address.full_name }}{% else %}{{ user.first_name }} {{ user.last_name }}{% endif %}" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Nomor Telepon *</label>
                            <input type="tel" id="phone" name="phone" placeholder="Contoh: 08123456789" 
                                   value="{% if user_profile.phone %}{{ user_profile.phone }}{% elif default_address %}{{ default_address.phone }}{% endif %}" required>
                        </div>

                        <div class="form-group">
                            <label for="address">Alamat Lengkap *</label>
                            <textarea id="address" name="address" rows="3" placeholder="Jl. Contoh No. 123, RT/RW, Kelurahan, Kecamatan" required>{% if user_profile.address %}{{ user_profile.address }}{% elif default_address %}{{ default_address.address }}{% endif %}</textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">Kota *</label>
                                <input type="text" id="city" name="city" placeholder="Contoh: Makassar" 
                                       value="{% if user_profile.city %}{{ user_profile.city }}{% elif default_address %}{{ default_address.city }}{% endif %}" required readonly style="background-color: #f5f5f5;">
                                <small class="form-help">Saat ini hanya melayani pengiriman di Makassar</small>
                            </div>
                            <div class="form-group">
                                <label for="province">Provinsi *</label>
                                <input type="text" id="province" name="province" placeholder="Contoh: Sulawesi Selatan" 
                                       value="{% if user_profile.province %}{{ user_profile.province }}{% elif default_address %}{{ default_address.province }}{% endif %}" required readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>

<!-- âœ… FIELD BARU: DROPDOWN KECAMATAN -->
<div class="form-group">
    <label for="district">Kecamatan *</label>
    <select id="district" name="district" required onchange="updateShippingCost()">
        <option value="">Pilih Kecamatan</option>
        {% for kecamatan in kecamatan_list %}
        <option value="{{ kecamatan.kecamatan }}" 
                {% if user_profile.district == kecamatan.kecamatan %}selected{% endif %}>
            {{ kecamatan.kecamatan }} - Rp {{ kecamatan.harga|rupiah }}
        </option>
        {% endfor %}
    </select>
    <small class="form-help">Pilih kecamatan untuk melihat biaya pengiriman</small>
</div>
                        <div class="form-group">
                            <label for="postal_code">Kode Pos (Opsional)</label>
                            <input type="text" id="postal_code" name="postal_code" placeholder="90123" 
                                   value="{% if user_profile.postal_code %}{{ user_profile.postal_code }}{% elif default_address %}{{ default_address.postal_code }}{% endif %}">
                        </div>

                        <!-- âœ… TAMPILAN BIAYA PENGIRIMAN REAL-TIME -->
                        <div class="shipping-cost-preview" id="shippingCostPreview" style="display: none;">
                            <div class="shipping-cost-card">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                                <div>
                                    <strong>Biaya Pengiriman:</strong>
                                    <span id="shippingCostDisplay">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-checkbox">
                            <input type="checkbox" id="save_address" name="save_address" value="1">
                            <label for="save_address">Simpan alamat sebagai alamat default untuk pembelian berikutnya</label>
                        </div>

                        <button type="button" class="btn-continue" onclick="showPayment()">Lanjutkan ke Pembayaran</button>
                    </div>

                    <!-- Pembayaran Section (Hidden by default) -->
                    <div class="checkout-section" id="paymentSection" style="display: none;">
                        <h2 class="section-title">Pembayaran</h2>
                        
                        <div class="payment-summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span class="amount">Rp {{ subtotal|floatformat:0|default:"0" }}</span>
                            </div>
                            <div class="summary-row">
                                <span>Biaya Pengiriman</span>
                                <span class="amount" id="finalShippingCost">Rp {{ shipping_cost|rupiah }}</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total</span>
                                <span class="amount" id="finalTotal">Rp {{ total|rupiah }}</span>
                            </div>
                        </div>

                        <h3 class="payment-method-title">Metode Pembayaran</h3>

                        <div class="payment-options">
                            <!-- âœ… HANYA MIDTRANS -->
                            <div class="payment-option selected">
                                <div class="payment-card">
                                    <div class="payment-info">
                                        <span class="payment-name">ðŸ’³ Midtrans Payment Gateway</span>
                                        <span class="payment-desc">Virtual Account, E-Wallet, Kartu Kredit, QRIS, dan lainnya</span>
                                    </div>
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="payment-notice">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p>Anda akan diarahkan ke halaman pembayaran Midtrans untuk menyelesaikan transaksi dengan berbagai pilihan metode pembayaran yang tersedia.</p>
                        </div>

                        <button type="submit" class="btn-checkout">Lanjutkan ke Pembayaran</button>
                    </div>
                </form>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="checkout-right">
                <div class="order-summary">
                    <h2 class="summary-title">Ringkasan Pesanan</h2>
                    <p class="summary-subtitle">Dijual dan dikirim oleh MancingMo</p>

                    <div class="order-items">
                        {% for item in cart_items %}
                        <div class="order-item">
                            <div class="item-image">
                                {% if item.product.get_main_image %}
                                <img src="{{ item.product.get_main_image }}" alt="{{ item.product.name }}">
                                {% else %}
                                <div class="no-image">No Image</div>
                                {% endif %}
                            </div>
                            <div class="item-details">
                                <h3 class="item-name">{{ item.product.name }}</h3>
                                <p class="item-spec">{{ item.product.description|truncatewords:5 }}</p>
                                <div class="item-footer">
                                    <span class="item-quantity">x {{ item.quantity }}</span>
                                    <span class="item-price">Rp {{ item.get_subtotal|rupiah }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="summary-totals">
    <div class="total-row">
        <span>Subtotal</span>
        <span>Rp {{ subtotal|rupiah }}</span>  <!-- PASTIKAN PAKAI FILTER RUPIAH -->
    </div>
    <div class="total-row">
        <span>Biaya Pengiriman</span>
        <span id="summary-shipping">Pilih kecamatan</span>
    </div>
    <div class="total-row final">
        <span>Total</span>
        <span id="summary-total">Rp {{ subtotal|rupiah }}</span>  <!-- PASTIKAN PAKAI FILTER RUPIAH -->
    </div>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Style untuk shipping cost preview */
.shipping-cost-preview {
    margin: 15px 0;
}

.shipping-cost-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background-color: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    color: #166534;
}

.shipping-cost-card svg {
    flex-shrink: 0;
}

.shipping-cost-card div {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

/* Style untuk form help text */
.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #6b7280;
}

/* Style untuk select district */
#district {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background-color: white;
}

#district:focus {
    outline: none;
    border-color: #00a651;
    box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.1);
}

/* Style untuk button states */
.btn-continue {
    width: 100%;
    padding: 15px;
    background-color: #00a651;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.btn-continue:hover:not(:disabled) {
    background-color: #008f45;
    transform: translateY(-2px);
}

.btn-continue:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* Style untuk error state */
.input-error {
    border-color: #e74c3c !important;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
}
</style>

<script>
// Data untuk auto-fill - PRIORITAS: UserProfile > Default Address
const savedAddressData = {
    full_name: "{% if user_profile.address %}{{ user.first_name }} {{ user.last_name }}{% elif default_address %}{{ default_address.full_name }}{% else %}{{ user.first_name }} {{ user.last_name }}{% endif %}",
    phone: "{% if user_profile.phone %}{{ user_profile.phone }}{% elif default_address %}{{ default_address.phone }}{% endif %}",
    address: "{% if user_profile.address %}{{ user_profile.address }}{% elif default_address %}{{ default_address.address }}{% endif %}",
    city: "{% if user_profile.city %}{{ user_profile.city }}{% elif default_address %}{{ default_address.city }}{% endif %}",
    province: "{% if user_profile.province %}{{ user_profile.province }}{% elif default_address %}{{ default_address.province }}{% endif %}",
    district: "{% if user_profile.district %}{{ user_profile.district }}{% elif default_address %}{{ default_address.district }}{% endif %}",
    postal_code: "{% if user_profile.postal_code %}{{ user_profile.postal_code }}{% elif default_address %}{{ default_address.postal_code }}{% endif %}"
};

// HARGA ONGKIR HARDCODE - PASTI BERES!
const shippingCosts = {
    'Biringkanaya': 12000,
    'Bontoala': 8000,
    'Kepulauan Sangkarrang': 25000,
    'Makassar': 9000,
    'Mamajang': 8500,
    'Manggala': 15000,
    'Mariso': 7500,
    'Panakkukang': 11000,
    'Rappocini': 10000,
    'Tallo': 9500,
    'Tamalanrea': 13000,
    'Tamalate': 10500,
    'Ujung Pandang': 7000,
    'Ujung Tanah': 8000,
    'Wajo': 9000,
};

// Function to format number to Rupiah - FIXED VERSION
function formatRupiah(number) {
    // Pastikan number adalah angka
    const num = parseInt(number);
    if (isNaN(num)) {
        return 'Rp 0';
    }
    
    // Format dengan separator ribuan
    return 'Rp ' + num.toLocaleString('id-ID');
}

// Function untuk parse subtotal dari Django template
function getSubtotal() {
    // Ambil subtotal dari elemen HTML yang sudah diformat
    const subtotalElement = document.querySelector('.summary-totals .total-row:first-child span:last-child');
    if (subtotalElement) {
        const subtotalText = subtotalElement.textContent.replace(/[^\d]/g, '');
        return parseInt(subtotalText) || 0;
    }
    
    // Fallback: parse dari Django template variable
    const djangoSubtotal = parseInt({{ subtotal|default:0 }});
    console.log('Django subtotal parsed:', djangoSubtotal);
    return djangoSubtotal;
}

// Function to update shipping cost based on selected kecamatan
function updateShippingCost() {
    const districtSelect = document.getElementById('district');
    const selectedDistrict = districtSelect.value;
    const shippingCostPreview = document.getElementById('shippingCostPreview');
    const shippingCostDisplay = document.getElementById('shippingCostDisplay');
    const summaryShipping = document.getElementById('summary-shipping');
    const summaryTotal = document.getElementById('summary-total');
    
    console.log('Selected district:', selectedDistrict);
    
    if (selectedDistrict && shippingCosts[selectedDistrict]) {
        const shippingCost = shippingCosts[selectedDistrict];
        const subtotal = getSubtotal(); // GUNAKAN FUNGSI BARU
        const total = subtotal + shippingCost;
        
        console.log('Shipping:', shippingCost, 'Subtotal:', subtotal, 'Total:', total);
        
        // Update preview
        shippingCostDisplay.textContent = formatRupiah(shippingCost);
        shippingCostPreview.style.display = 'block';
        
        // Update summary
        summaryShipping.textContent = formatRupiah(shippingCost);
        summaryTotal.textContent = formatRupiah(total);
        
        // Update payment section jika sudah terbuka
        const finalShippingCost = document.getElementById('finalShippingCost');
        const finalTotal = document.getElementById('finalTotal');
        if (finalShippingCost) {
            finalShippingCost.textContent = formatRupiah(shippingCost);
            finalTotal.textContent = formatRupiah(total);
        }
        
        // Enable continue button jika semua field sudah terisi
        checkFormValidity();
    } else {
        shippingCostPreview.style.display = 'none';
        summaryShipping.textContent = 'Pilih kecamatan';
        summaryTotal.textContent = formatRupiah(getSubtotal());
        
        // Disable continue button
        const continueBtn = document.querySelector('.btn-continue');
        continueBtn.disabled = true;
        continueBtn.style.opacity = '0.5';
        continueBtn.style.cursor = 'not-allowed';
    }
}

// Function to check form validity
function checkFormValidity() {
    const fullName = document.getElementById('full_name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const district = document.getElementById('district').value.trim();
    const continueBtn = document.querySelector('.btn-continue');
    
    const isValid = fullName && phone && address && district;
    
    if (isValid) {
        continueBtn.disabled = false;
        continueBtn.style.opacity = '1';
        continueBtn.style.cursor = 'pointer';
    } else {
        continueBtn.disabled = true;
        continueBtn.style.opacity = '0.5';
        continueBtn.style.cursor = 'not-allowed';
    }
    
    return isValid;
}

// Function to use saved address (from profile or default address)
function useSavedAddress() {
    document.getElementById('full_name').value = savedAddressData.full_name || '';
    document.getElementById('phone').value = savedAddressData.phone || '';
    document.getElementById('address').value = savedAddressData.address || '';
    document.getElementById('city').value = savedAddressData.city || 'Makassar';
    document.getElementById('province').value = savedAddressData.province || 'Sulawesi Selatan';
    document.getElementById('postal_code').value = savedAddressData.postal_code || '';
    
    // Set district jika ada
    if (savedAddressData.district) {
        const districtSelect = document.getElementById('district');
        for (let i = 0; i < districtSelect.options.length; i++) {
            if (districtSelect.options[i].value === savedAddressData.district) {
                districtSelect.selectedIndex = i;
                break;
            }
        }
        // Trigger update shipping cost
        updateShippingCost();
    }
    
    // Check form validity setelah auto-fill
    checkFormValidity();
    
    // Remove notice if exists
    const notice = document.querySelector('.address-notice');
    if (notice) {
        notice.remove();
    }
}

// Function to show payment section
function showPayment() {
    const form = document.getElementById('checkoutForm');
    const requiredFields = form.querySelectorAll('.checkout-section:first-child input[required], .checkout-section:first-child textarea[required], .checkout-section:first-child select[required]');
    
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = '#e74c3c';
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            field.style.borderColor = '#ddd';
        }
    });

    // Validasi khusus untuk kecamatan
    const districtSelect = document.getElementById('district');
    if (!districtSelect.value) {
        isValid = false;
        districtSelect.style.borderColor = '#e74c3c';
        districtSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    if (isValid) {
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update final totals di payment section
        const selectedDistrict = districtSelect.value;
        if (selectedDistrict && shippingCosts[selectedDistrict]) {
            const shippingCost = shippingCosts[selectedDistrict];
            const subtotal = getSubtotal(); // GUNAKAN FUNGSI BARU
            const total = subtotal + shippingCost;
            
            document.getElementById('finalShippingCost').textContent = formatRupiah(shippingCost);
            document.getElementById('finalTotal').textContent = formatRupiah(total);
        }
    } else {
        alert('Mohon lengkapi semua data pengiriman yang wajib diisi termasuk kecamatan!');
    }
}

// Reset border color on input/select change
document.querySelectorAll('input, textarea, select').forEach(field => {
    field.addEventListener('input', function() {
        this.style.borderColor = '#ddd';
        checkFormValidity();
    });
    field.addEventListener('change', function() {
        this.style.borderColor = '#ddd';
        checkFormValidity();
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loaded');
    
    // Auto-set city and province to Makassar jika kosong
    const cityField = document.getElementById('city');
    const provinceField = document.getElementById('province');
    
    if (!cityField.value) cityField.value = 'Makassar';
    if (!provinceField.value) provinceField.value = 'Sulawesi Selatan';
    
    // Set initial summary total
    const initialSubtotal = getSubtotal();
    document.getElementById('summary-total').textContent = formatRupiah(initialSubtotal);
    
    // Trigger update shipping cost if district is pre-selected
    const districtSelect = document.getElementById('district');
    if (districtSelect.value) {
        console.log('District pre-selected:', districtSelect.value);
        updateShippingCost();
    }
    
    // Check form validity on load
    checkFormValidity();
    
    // Debug: Log initial values
    console.log('Initial subtotal calculated:', initialSubtotal);
});
</script>

{% endblock %}