{% extends 'base.html' %}
{% load static %}
{% load currency_filters %}

{% block title %}Keranjang - MancingMo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<!-- Page Hero -->
<section class="page-hero">
    <h1 class="page-title">Cart</h1>
    <div class="breadcrumb">
        <a href="{% url 'home' %}">Home</a>
        <span>></span>
        <span>Cart</span>
    </div>
</section>

<!-- Cart Container -->
<section class="cart-container">
    {% if cart_items %}
    <!-- Action Buttons -->
    <div class="cart-actions">
        <button type="button" class="btn-delete-selected" id="delete-selected-btn" onclick="deleteSelectedItems()" disabled>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Hapus Dipilih
        </button>
    </div>

    <!-- Cart Table -->
    <div class="cart-table">
        <!-- Table Header -->
        <div class="table-header">
            <div>
                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)">
            </div>
            <div>Produk</div>
            <div>Harga</div>
            <div>Kuantitas</div>
            <div>Total</div>
        </div>

        <!-- Cart Items -->
        {% for item in cart_items %}
        <div class="cart-item" data-item-id="{{ item.id }}">
            <!-- Checkbox -->
            <div>
                <input type="checkbox" class="item-checkbox" 
                       data-item-id="{{ item.id }}" 
                       data-price="{{ item.product.price|floatformat:0 }}"
                       data-quantity="{{ item.quantity }}"
                       data-subtotal="{{ item.get_subtotal|floatformat:0 }}"
                       onchange="updateCartSummary()">
            </div>

            <!-- Product Details -->
            <div class="item-details">
                <div class="item-image">
                    {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                    {% else %}
                    <img src="{% static 'image/no-image.png' %}" alt="No Image">
                    {% endif %}
                </div>
                <div class="item-info">
                    <h3>{{ item.product.name }}</h3>
                    <div class="item-variant">{{ item.product.category.name }}</div>
                    <div class="item-actions">
                        <form method="post" action="{% url 'remove_from_cart' item.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn" onclick="return confirm('Hapus produk ini dari keranjang?')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Hapus
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Price -->
            <div class="item-price">
                Rp {{ item.product.price|rupiah }}
            </div>

            <!-- Quantity -->
            <div class="item-quantity">
                <button class="qty-btn" onclick="updateQuantity({{ item.id }}, 'decrease')">-</button>
                <span class="qty-display" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                <button class="qty-btn" onclick="updateQuantity({{ item.id }}, 'increase')">+</button>
            </div>

            <!-- Total -->
            <div class="item-total" id="subtotal-{{ item.id }}">
                Rp {{ item.get_subtotal|rupiah }}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Cart Summary -->
    <div class="cart-summary">
        <div class="summary-row">
            <span>Subtotal</span>
            <span id="cart-subtotal">Rp 0</span>
        </div>
        <div class="summary-row total">
            <span>Total</span>
            <span id="cart-total">Rp 0</span>
        </div>
        <button type="button" class="btn-checkout" id="checkout-btn" onclick="proceedToCheckout()" disabled>Checkout</button>
        <a href="{% url 'shop' %}" class="link-continue">Lanjut Belanja</a>
    </div>

    {% else %}
    <!-- Empty Cart -->
    <div class="empty-cart">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
        </svg>
        <h3>Keranjang Anda Kosong</h3>
        <p>Belum ada produk yang ditambahkan ke keranjang</p>
        <a href="{% url 'shop' %}" class="btn-shop">Mulai Belanja</a>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
// Function to format number to Rupiah with dot separator
function formatRupiah(number) {
    return 'Rp ' + Math.floor(number).toLocaleString('id-ID');
}

// Function to update cart summary based on checked items
function updateCartSummary() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    let total = 0;
    let hasChecked = false;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            hasChecked = true;
            // Parse subtotal as number and handle any formatting
            const subtotalStr = checkbox.dataset.subtotal.replace(/\./g, '').replace(/,/g, '');
            const subtotal = parseFloat(subtotalStr);
            total += subtotal;
        }
    });
    
    // Update summary display
    document.getElementById('cart-subtotal').textContent = formatRupiah(total);
    document.getElementById('cart-total').textContent = formatRupiah(total);
    
    // Enable/disable checkout button
    const checkoutBtn = document.getElementById('checkout-btn');
    if (hasChecked) {
        checkoutBtn.disabled = false;
        checkoutBtn.style.opacity = '1';
        checkoutBtn.style.cursor = 'pointer';
    } else {
        checkoutBtn.disabled = true;
        checkoutBtn.style.opacity = '0.5';
        checkoutBtn.style.cursor = 'not-allowed';
    }
    
    // Enable/disable delete selected button
    const deleteBtn = document.getElementById('delete-selected-btn');
    if (hasChecked) {
        deleteBtn.disabled = false;
        deleteBtn.style.opacity = '1';
        deleteBtn.style.cursor = 'pointer';
    } else {
        deleteBtn.disabled = true;
        deleteBtn.style.opacity = '0.5';
        deleteBtn.style.cursor = 'not-allowed';
    }
    
    // Update "select all" checkbox state
    updateSelectAllCheckbox();
}

// Function to toggle select all
function toggleSelectAll(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateCartSummary();
}

// Function to update "select all" checkbox state
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Function to delete selected items
function deleteSelectedItems() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Pilih minimal 1 produk untuk dihapus!');
        return;
    }
    
    const itemCount = checkboxes.length;
    const confirmation = confirm(`Hapus ${itemCount} produk yang dipilih dari keranjang?`);
    
    if (!confirmation) {
        return;
    }
    
    // Collect selected item IDs
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.itemId);
    
    // Send AJAX request to delete items
    fetch('{% url "delete_selected_items" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ item_ids: selectedIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove items from DOM
            selectedIds.forEach(id => {
                const itemElement = document.querySelector(`.cart-item[data-item-id="${id}"]`);
                if (itemElement) {
                    itemElement.remove();
                }
            });
            
            // Check if cart is empty
            const remainingItems = document.querySelectorAll('.cart-item');
            if (remainingItems.length === 0) {
                // Reload page to show empty cart message
                location.reload();
            } else {
                // Update summary
                updateCartSummary();
                alert(data.message);
            }
        } else {
            alert(data.message || 'Terjadi kesalahan saat menghapus produk.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan. Silakan refresh halaman.');
    });
}

// Function to proceed to checkout with selected items
function proceedToCheckout() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Pilih minimal 1 produk untuk checkout!');
        return;
    }
    
    // Collect selected item IDs
    const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.itemId);
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "checkout" %}';
    
    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    form.appendChild(csrfInput);
    
    // Add selected item IDs
    selectedIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_items';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// Function to update quantity via AJAX
function updateQuantity(itemId, action) {
    fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update quantity display
            document.getElementById(`qty-${itemId}`).textContent = data.quantity;
            
            // Update subtotal display
            document.getElementById(`subtotal-${itemId}`).textContent = formatRupiah(data.subtotal);
            
            // Update checkbox data
            const checkbox = document.querySelector(`.item-checkbox[data-item-id="${itemId}"]`);
            if (checkbox) {
                checkbox.dataset.quantity = data.quantity;
                checkbox.dataset.subtotal = data.subtotal;
            }
            
            // Recalculate cart summary if item is checked
            updateCartSummary();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan. Silakan refresh halaman.');
    });
}

// Function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCartSummary();
});
</script>
{% endblock %}