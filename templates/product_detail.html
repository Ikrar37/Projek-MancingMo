{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.name }} - MancingMo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
<style>
/* ✅ TOAST NOTIFICATION STYLES */
.toast {
    position: fixed;
    top: 100px;
    right: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 9999;
    min-width: 300px;
    font-weight: 500;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.error {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.toast svg {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
}

.toast span {
    flex: 1;
    font-size: 15px;
}

/* Loading state untuk button */
.btn-cart.loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
}

.btn-cart.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spinner 0.6s linear infinite;
}

@keyframes spinner {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<!-- ✅ TOAST NOTIFICATION -->
<div class="toast" id="toast">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
    </svg>
    <span id="toastMessage">Produk berhasil ditambahkan ke keranjang!</span>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Product Detail -->
    <div class="product-detail">
        <!-- LEFT: Image Section -->
        <div class="product-image-container">
            <div class="main-image-wrapper">
                {% if product.images.all.count > 1 %}
                <button class="image-nav prev" onclick="changeImage(-1)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                {% endif %}
                
                {% if product.images.exists %}
                    <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" id="mainImage">
                {% elif product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" id="mainImage">
                {% else %}
                    <img src="{% static 'image/no-image.png' %}" alt="No Image" id="mainImage">
                {% endif %}
                
                {% if product.images.all.count > 1 %}
                <button class="image-nav next" onclick="changeImage(1)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
                {% endif %}
            </div>
            
            {% if product.images.all.count > 1 %}
            <div class="thumbnail-container">
                {% for image in product.images.all %}
                <div class="thumbnail {% if forloop.first %}active{% endif %}" onclick="selectImage({{ forloop.counter0 }})">
                    <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- RIGHT: Product Info -->
        <div class="product-info">
            <h1>{{ product.name }}</h1>
            
            <div class="rating">
                <span class="stars">★★★★★</span>
                <span class="rating-text">(0) | 0 Terjual</span>
            </div>
            
            <div class="price">Rp {{ product.price|floatformat:0|intcomma }}</div>
            
            <div class="delivery-info">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                </svg>
                Estimasi pengiriman: 3-7 hari kerja
            </div>
            
            <div class="stock-info">
                {% if product.stock > 0 %}
                <span class="stock-badge in-stock">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Stok tersedia ({{ product.stock }} item)
                </span>
                {% else %}
                <span class="stock-badge out-of-stock">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Stok habis
                </span>
                {% endif %}
            </div>
            
            {% if product.stock > 0 %}
            <form method="post" action="{% url 'add_to_cart' product.id %}" id="addToCartForm">
                {% csrf_token %}
                <div class="quantity-section">
                    <h3>Jumlah</h3>
                    <div class="quantity-control">
                        <button type="button" class="qty-btn" onclick="decreaseQty()">-</button>
                        <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" class="qty-input" id="qty-input" readonly>
                        <button type="button" class="qty-btn" onclick="increaseQty()">+</button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    {% if user.is_authenticated %}
                    <button type="submit" class="btn btn-cart" id="addToCartBtn">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        Tambah ke Keranjang
                    </button>
                    <button type="button" class="btn btn-buy" onclick="buyNow()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Beli Sekarang
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-cart" onclick="window.location.href='{% url 'login' %}?next={{ request.path }}'">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Login untuk Membeli
                    </button>
                    {% endif %}
                </div>
            </form>
            {% else %}
            <div class="action-buttons">
                <button class="btn btn-cart" disabled>Stok Habis</button>
            </div>
            {% endif %}
            
            <div class="product-actions">
                <div class="action-link">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share
                </div>
            </div>
        </div>
    </div>

    <!-- Rincian Produk -->
    <div class="detail-section">
        <h2>Rincian Produk</h2>
        <table class="detail-table">
            <tr>
                <td>Stok</td>
                <td>{{ product.stock }}</td>
            </tr>
            <tr>
                <td>Kategori</td>
                <td><a href="{% url 'shop' %}?category={{ product.category.slug }}">{{ product.category.name }}</a></td>
            </tr>
            <tr>
                <td>Status</td>
                <td>
                    {% if product.is_active %}
                    <span style="color: #4caf50;">✓ Aktif</span>
                    {% else %}
                    <span style="color: #f44336;">✗ Tidak Aktif</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>

    <!-- Deskripsi Produk -->
    <div class="detail-section">
        <h2>Deskripsi Produk</h2>
        <div class="description-content">
            {{ product.description|linebreaks }}
        </div>
    </div>

    <!-- Produk Terkait -->
    {% if related_products %}
    <div class="related-products">
        <h2 class="section-title">Produk Terkait</h2>
        <div class="product-grid">
            {% for related in related_products %}
            <div class="product-card" onclick="window.location.href='{% url 'product_detail' related.slug %}';">
                <div class="product-image">
                    {% if related.images.exists %}
                    <img src="{{ related.images.first.image.url }}" alt="{{ related.name }}">
                    {% elif related.image %}
                    <img src="{{ related.image.url }}" alt="{{ related.name }}">
                    {% else %}
                    <img src="{% static 'image/no-image.png' %}" alt="No Image">
                    {% endif %}
                </div>
                <div class="product-card-info">
                    <div class="product-name">{{ related.name }}</div>
                    <div class="product-brand">{{ related.category.name }}</div>
                    <div class="product-price">Rp {{ related.price|floatformat:0|intcomma }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        <button class="show-more-btn" onclick="window.location.href='{% url 'shop' %}'">Lihat Semua Produk</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const maxStock = {{ product.stock }};
const images = [
    {% if product.images.exists %}
        {% for image in product.images.all %}"{{ image.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}
    {% elif product.image %}
        "{{ product.image.url }}"
    {% endif %}
];
let currentImageIndex = 0;

// ============ IMAGE GALLERY ============
function changeImage(direction) {
    if (images.length <= 1) return;
    currentImageIndex += direction;
    if (currentImageIndex < 0) currentImageIndex = images.length - 1;
    else if (currentImageIndex >= images.length) currentImageIndex = 0;
    updateImage();
}

function selectImage(index) {
    currentImageIndex = index;
    updateImage();
}

function updateImage() {
    const mainImage = document.getElementById('mainImage');
    if (mainImage && images[currentImageIndex]) {
        mainImage.src = images[currentImageIndex];
    }
    document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentImageIndex);
    });
}

// ============ QUANTITY CONTROLS ============
function increaseQty() {
    const input = document.getElementById('qty-input');
    if (parseInt(input.value) < maxStock) input.value = parseInt(input.value) + 1;
}

function decreaseQty() {
    const input = document.getElementById('qty-input');
    if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
}

// ============ TOAST NOTIFICATION ============
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    
    if (isError) {
        toast.classList.add('error');
    } else {
        toast.classList.remove('error');
    }
    
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// ============ ADD TO CART - AJAX ============
{% if user.is_authenticated %}
document.getElementById('addToCartForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    
    const form = this;
    const btn = document.getElementById('addToCartBtn');
    const formData = new FormData(form);
    
    // Add loading state
    btn.classList.add('loading');
    btn.disabled = true;
    
    // Send AJAX request
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading state
        btn.classList.remove('loading');
        btn.disabled = false;
        
        if (data.success) {
            // Show success toast
            showToast(data.message, false);
            
            // Update cart badge in header
            if (typeof window.updateCartBadge === 'function') {
                window.updateCartBadge(data.cart_count);
            }
            
            // Reset quantity to 1
            document.getElementById('qty-input').value = 1;
        } else {
            // Show error toast
            showToast(data.message, true);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.classList.remove('loading');
        btn.disabled = false;
        showToast('Terjadi kesalahan. Silakan coba lagi.', true);
    });
});
{% endif %}

// ============ BUY NOW ============
function buyNow() {
    {% if user.is_authenticated %}
    const form = document.getElementById('addToCartForm');
    const formData = new FormData(form);
    
    // Add to cart first via AJAX
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to cart/checkout
            window.location.href = '{% url "cart" %}';
        } else {
            showToast(data.message, true);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Terjadi kesalahan. Silakan coba lagi.', true);
    });
    {% else %}
    window.location.href = '{% url "login" %}?next={{ request.path }}';
    {% endif %}
}
</script>
{% endblock %}